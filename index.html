<!DOCTYPE html>
<head>
  <script src="js/qrcodegen-v1.8.0-es6.js"></script>
  <title>Hand Pass</title>
  <link rel="icon" href="icon-180x180.png" type="image/png" />
  <link rel="apple-touch-icon" href="icon-180x180.png" />
  <meta name="apple-mobile-web-app-capable" content="yes" />

  <!-- Disable ios zoom on input focus -->
  <meta name="viewport" content="initial-scale=1, maximum-scale=1" />
  <!-- Progressive web app support -->
  <link rel="manifest" href="manifest.json" />

  <style>
    :root {
      --dark: black;
      --light: white;
    }
    * {
      white-space: nowrap;
      font-size: large;
      color: var(--dark);
      background-color: var(--light);
      font-family: sans-serif;
    }
    html,
    body {
      height: 100%;
      width: 100%;
      padding: 0;
      margin: 0;
      background-color: var(--light);
    }
    body {
      display: flex;
      flex-direction: column;
      justify-content: center;
      gap: 0.5rem;
    }
    #qrCodeCanvas,
    #phoneNumberInput {
      margin-left: auto;
      margin-right: auto;
      display: block;
      box-sizing: border-box;
      width: calc(min(100vw - 2rem, 100vh - 7rem));
    }
    #qrCodeCanvas {
      aspect-ratio: 1;
      object-fit: cover;
      overflow: hidden;
      image-rendering: pixelated;
    }
    #instructions {
      text-align: center;
    }
    #phoneNumberInput {
      padding: 1rem;
      text-align: center;
      border: 0.125rem solid;
      border-radius: 0;
    }
    #links {
      list-style: none;
      padding: 0;
      margin: 1rem;
    }
    #aboutSection {
      position: absolute;
      bottom: 0;
      left: 0;
      padding: 0;
      margin: 0;
      background-color: transparent;
    }
  </style>
</head>
<body>
  <canvas id="qrCodeCanvas"></canvas>
  <div id="instructions">Enter number to make QR code</div>
  <input id="phoneNumberInput" type="tel" placeholder="My Number" />
  <div id="aboutSection">
    <ul id="links">
      <!-- li>iOS App (soon)</li>
      <li>Android App (soon)</li -->
      <li>
        <a href="https://github.com/GayanEdiriweera/handpass">About</a>
      </li>
    </ul>
  </div>
  <script>
    initialize();
    function initialize() {
      const phoneNumber = localStorage.getItem("phoneNumber") ?? "";
      phoneNumberInput.value = phoneNumber;
      phoneNumberInput.oninput = (event) => {
        const newPhoneNumber = event.target.value;
        localStorage.setItem("phoneNumber", newPhoneNumber);
        refreshCanvas(newPhoneNumber);
      };
      refreshCanvas(phoneNumber);
    }

    function refreshCanvas(phoneNumber) {
      const code = phoneNumber
        ? qrcodegen.QrCode.encodeText(
            encodeURI(`sms:${phoneNumber}`),
            qrcodegen.QrCode.Ecc.MEDIUM
          )
        : { size: 0 };

      const rootStyle = getComputedStyle(document.querySelector(":root"));
      const dark = rootStyle.getPropertyValue("--dark");
      const light = rootStyle.getPropertyValue("--light");
      const context = qrCodeCanvas.getContext("2d");
      drawCodeToCanvas(qrCodeCanvas, context, code, dark, light);
    }

    function drawCodeToCanvas(canvas, context, code, dark, light) {
      if (code.size == 0) {
        instructions.style.display = "block";
        canvas.style.display = "none";
        return;
      }
      instructions.style.display = "none";
      canvas.style.display = "block";
      canvas.width = code.size + 4;
      canvas.height = code.size + 4;

      for (let y = 0; y < canvas.height; y++) {
        for (let x = 0; x < canvas.width; x++) {
          if (
            x == 0 ||
            y == 0 ||
            x == canvas.width - 1 ||
            y == canvas.height - 1
          ) {
            // outer outline
            context.fillStyle = dark;
          } else if (
            x == 1 ||
            y == 1 ||
            x == canvas.width - 2 ||
            y == canvas.height - 2
          ) {
            // inner outline
            context.fillStyle = light;
          } else {
            // code
            context.fillStyle = code.modules[y - 2][x - 2] ? dark : light;
          }
          context.fillRect(x, y, 1, 1);
        }
      }
    }
  </script>
</body>
