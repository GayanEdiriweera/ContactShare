<!DOCTYPE html>
<head>
  <script src="js/qrcodegen-v1.8.0-es6.js"></script>
  <title>Hand Pass</title>
  <link rel="icon" href="assets/icons/icon-180x180.png" type="image/png" />
  <link rel="apple-touch-icon" href="assets/icons/icon-180x180.png" />
  <meta name="apple-mobile-web-app-capable" content="yes" />

  <!-- Disable ios zoom on input focus -->
  <meta name="viewport" content="initial-scale=1, maximum-scale=1" />
  <!-- Progressive web app support -->
  <link rel="manifest" href="manifest.json" />

  <style>
    :root {
      --dark: black;
      --light: white;
    }
    * {
      white-space: nowrap;
      font-size: large;
      color: var(--dark);
      background-color: var(--light);
      font-family: sans-serif;
    }
    html,
    body {
      height: 100%;
      width: 100%;
      padding: 0;
      margin: 0;
      background-color: var(--light);
    }
    body {
      display: flex;
      flex-direction: column;
      justify-content: center;
      gap: 0.5rem;
    }
    #qrCodeCanvas,
    #phoneNumberInput {
      margin-left: auto;
      margin-right: auto;
      display: block;
      box-sizing: border-box;
      width: calc(min(100vw - 2rem, 100vh - 7rem));
    }
    #qrCodeCanvas {
      aspect-ratio: 1;
      object-fit: cover;
      overflow: hidden;
      image-rendering: pixelated;
    }
    #instructions {
      text-align: center;
    }
    #phoneNumberInput {
      padding: 1rem;
      text-align: center;
      border: 0.125rem solid;
      border-radius: 0;
    }
    #links {
      list-style: none;
      padding: 0;
      margin: 1rem;
    }
    #menuButton {
      position: absolute;
      top: 0;
      left: 0;
      padding: 0;
      margin: 1rem;
      border: 0.125rem solid black;
      background-color: white;
    }
    .button {
      width: 3rem;
      height: 3rem;
    }
    #menu {
      width: 15rem;
      height: 100vh;
      border-right: 0.125rem solid black;
    }
    .functionLink[selected] {
      border-right: 0.5rem solid black;
    }

    #menu a {
      background-color: #eee; /* Grey background color */
      color: black; /* Black text color */
      display: block; /* Make the links appear below each other */
      padding: 0.75rem; /* Add some padding */
      text-decoration: none; /* Remove underline from links */
    }
    #menu a[disabled] {
      color: #bbb;
    }

    #modalParent {
      display: none; /* Hidden by default */
      position: absolute; /* Stay in place */
      left: 0;
      top: 0;
      z-index: 1;
      width: 100%; /* Full width */
      height: 100%; /* Full height */
      background-color: rgba(0, 0, 0, 0.5); /* Black w/ opacity */
    }

    .icon {
      width: 3rem;
    }
  </style>
  <script>
    navigator.serviceWorker.register("service-worker.js");
  </script>
</head>
<body>
  <canvas id="qrCodeCanvas"></canvas>
  <div id="instructions">Enter number to make QR code</div>
  <input id="phoneNumberInput" type="tel" placeholder="My Number" />
  <div id="menuButton" class="button">
    <img class="icon" src="assets/icons/menu.png" />
  </div>
  <div id="modalParent">
    <div id="menu">
      <div id="closeButton" class="button">
        <img class="icon" src="assets/icons/close.png" />
      </div>
      <a class="functionLink" selected id="textBack">Text Back</a>
      <a class="functionLink" disabled>Contact Card (soon)</a>
      <br />
      <a disabled>iOS App (soon)</a>
      <a href="https://play.google.com/store/apps/details?id=app.handpass.twa"
        >Android App</a
      >
      <a href="https://github.com/GayanEdiriweera/handpass">About</a>
    </div>
  </div>
  <script>
    menuButton.onclick = function () {
      modalParent.style.display = "block";
    };
    closeButton.onclick = function () {
      modalParent.style.display = "none";
    };

    if ("ontouchstart" in document) {
      document.ontouchstart = function (event) {
        if (event.target == modalParent) {
          modalParent.style.display = "none";
        }
      };
    } else {
      document.onclick = function (event) {
        if (event.target == modalParent) {
          modalParent.style.display = "none";
        }
      };
    }

    initialize();
    function initialize() {
      const phoneNumber = localStorage.getItem("phoneNumber") ?? "";
      phoneNumberInput.value = phoneNumber;
      phoneNumberInput.oninput = (event) => {
        const newPhoneNumber = event.target.value;
        localStorage.setItem("phoneNumber", newPhoneNumber);
        refreshCanvas(newPhoneNumber);
      };
      refreshCanvas(phoneNumber);
    }

    function refreshCanvas(phoneNumber) {
      const code = phoneNumber
        ? qrcodegen.QrCode.encodeText(
            encodeURI(`sms:${phoneNumber}`),
            qrcodegen.QrCode.Ecc.MEDIUM
          )
        : { size: 0 };

      const rootStyle = getComputedStyle(document.querySelector(":root"));
      const dark = rootStyle.getPropertyValue("--dark");
      const light = rootStyle.getPropertyValue("--light");
      const context = qrCodeCanvas.getContext("2d");
      drawCodeToCanvas(qrCodeCanvas, context, code, dark, light);
    }

    function drawCodeToCanvas(canvas, context, code, dark, light) {
      if (code.size == 0) {
        instructions.style.display = "block";
        canvas.style.display = "none";
        return;
      }
      instructions.style.display = "none";
      canvas.style.display = "block";
      canvas.width = code.size + 4;
      canvas.height = code.size + 4;

      for (let y = 0; y < canvas.height; y++) {
        for (let x = 0; x < canvas.width; x++) {
          if (
            x == 0 ||
            y == 0 ||
            x == canvas.width - 1 ||
            y == canvas.height - 1
          ) {
            // outer outline
            context.fillStyle = dark;
          } else if (
            x == 1 ||
            y == 1 ||
            x == canvas.width - 2 ||
            y == canvas.height - 2
          ) {
            // inner outline
            context.fillStyle = light;
          } else {
            // code
            context.fillStyle = code.modules[y - 2][x - 2] ? dark : light;
          }
          context.fillRect(x, y, 1, 1);
        }
      }
    }
  </script>
</body>
